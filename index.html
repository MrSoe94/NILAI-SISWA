<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Input Data Siswa</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Styles for print */
        @media print {
            body > div:not(.printable-area) {
                display: none; /* Hide everything except the printable area */
            }
            .printable-area {
                display: block;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }
            .printable-area table {
                width: 100%;
                border-collapse: collapse;
            }
            .printable-area th, .printable-area td {
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
            }
            .printable-area .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
    <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-6xl">
        <!-- Header Section -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">Kelas Pintar</h1>
            <nav class="flex space-x-2 sm:space-x-4">
                <button id="mainDataBtn" class="flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A1 1 0 009.586 3H10a2 2 0 012 2v.586l1.121 1.121A1 1 0 0014.586 7H16a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V7a2 2 0 012-2zm3 8a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Data Siswa
                </button>
                <button id="attendanceBtn" class="flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                    </svg>
                    Daftar Absensi
                </button>
                <button id="sortedDataBtn" class="flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L4.293 6.707A1 1 0 014 6V3z" clip-rule="evenodd" />
                    </svg>
                    Sortir Peminatan
                </button>
            </nav>
        </header>

        <!-- Main Data Section (Input Form + Student Data Table) -->
        <div id="mainDataSection">
            <!-- Input Data Section -->
            <section id="inputDataSection" class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Input Data Siswa</h2>
                <form id="studentForm" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Bagian 1: Data Siswa -->
                    <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-gray-700 mb-4">Detail Siswa</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nama" class="block text-sm font-medium text-gray-700">Nama</label>
                                <input type="text" id="nama" name="nama" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                            </div>
                            <div>
                                <label for="kelas" class="block text-sm font-medium text-gray-700">Kelas</label>
                                <input type="text" id="kelas" name="kelas" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Peminatan</label>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="minat1" name="minat" value="IPA" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="minat1" class="ml-2 text-sm text-gray-700">IPA</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="minat2" name="minat" value="IPS" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="minat2" class="ml-2 text-sm text-gray-700">IPS</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="minat3" name="minat" value="Bahasa" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="minat3" class="ml-2 text-sm text-gray-700">Bahasa</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="minat4" name="minat" value="Olahraga" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="minat4" class="ml-2 text-sm text-gray-700">Olahraga</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="minat5" name="minat" value="Seni" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="minat5" class="ml-2 text-sm text-gray-700">Seni</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="minat6" name="minat" value="Teknologi" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="minat6" class="ml-2 text-sm text-gray-700">Teknologi</label>
                                    </div>
                                </div>
                                <label for="otherMinat" class="block text-sm font-medium text-gray-700 mt-2">Peminatan Lainnya (opsional)</label>
                                <input type="text" id="otherMinat" name="otherMinat" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="keterangan" class="block text-sm font-medium text-gray-700">Keterangan</label>
                                <input type="text" id="keterangan" name="keterangan" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                        </div>
                    </div>

                    <!-- Bagian 2: Nilai dan Informasi Tambahan -->
                    <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                        <h3 class="text-lg font-medium text-gray-700 mb-4">Nilai & Informasi Umum</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="tanggalNilai1" class="block text-sm font-medium text-gray-700">Tanggal Nilai 1</label>
                                <input type="date" id="tanggalNilai1" name="tanggalNilai1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="tanggalNilai2" class="block text-sm font-medium text-gray-700">Tanggal Nilai 2</label>
                                <input type="date" id="tanggalNilai2" name="tanggalNilai2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="tanggalNilai3" class="block text-sm font-medium text-gray-700">Tanggal Nilai 3</label>
                                <input type="date" id="tanggalNilai3" name="tanggalNilai3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="tanggalNilai4" class="block text-sm font-medium text-gray-700">Tanggal Nilai 4</label>
                                <input type="date" id="tanggalNilai4" name="tanggalNilai4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="tanggalNilai5" class="block text-sm font-medium text-gray-700">Tanggal Nilai 5</label>
                                <input type="date" id="tanggalNilai5" name="tanggalNilai5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div class="md:col-span-2">
                                <label for="kepalaSekolah" class="block text-sm font-medium text-gray-700">Nama Kepala Sekolah</label>
                                <input type="text" id="kepalaSekolah" name="kepalaSekolah" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div class="md:col-span-2">
                                <label for="penanggungJawab" class="block text-sm font-medium text-gray-700">Nama Penanggung Jawab</label>
                                <input type="text" id="penanggungJawab" name="penanggungJawab" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 flex justify-end mt-4">
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">Tambah Siswa</button>
                    </div>
                </form>
            </section>

            <!-- View Data Section (always visible, placed below input form) -->
            <section id="lihatDataSection" class="mb-8 printable-area">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Data Siswa untuk Dicetak</h2>
                <div class="flex justify-end space-x-2 mb-4 no-print">
                    <button id="printMainBtn" class="flex items-center px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v5a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Print
                    </button>
                    <button id="downloadPdfMainBtn" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M.879 7.513A1 1 0 011.707 7h16.586a1 1 0 01.828.487.997.997 0 01-.112 1.022l-6 6a1 1 0 01-1.414 0l-6-6a.997.997 0 01-.112-1.022zM13 16a1 1 0 100 2h4a1 1 0 100-2h-4zM3 16a1 1 0 100 2h4a1 1 0 100-2H3z" clip-rule="evenodd" />
                        </svg>
                        Download PDF
                    </button>
                </div>

                <!-- Table Container for Horizontal Scrolling -->
                <div class="overflow-x-auto rounded-lg shadow-md table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NO</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAMA</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KELAS</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PEMINATAN</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 1</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 2</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 3</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 4</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 5</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KET</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Student data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 text-sm text-gray-600">
                    <p>Tanggal: <span id="currentDate"></span></p>
                    <p>Total Siswa: <span id="totalStudents">0</span></p>
                </div>

                <div class="flex justify-between items-end mt-8 text-sm">
                    <div>
                        <p>Mengetahui,</p>
                        <p class="font-semibold mt-1" id="displayKepalaSekolah">Kepala Sekolah</p>
                        <div class="border-b-2 border-gray-400 w-32 mt-8"></div>
                    </div>
                    <div class="text-right">
                        <p>Sampali, <span id="sampaliDate"></span></p>
                        <p class="font-semibold mt-1" id="displayPenanggungJawab">Guru Pembimbing</p>
                        <div class="border-b-2 border-gray-400 w-32 mt-8 ml-auto"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Attendance Section -->
        <div id="attendanceSection" class="hidden printable-area">
            <section class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 text-center mb-4">DAFTAR ABSENSI SISWA EKSTENSIL</h2>
                <h3 class="text-lg font-bold text-gray-700 text-center mb-6">MIS ANUGERAH SAMPALI TP 2025 - 2026</h3>

                <form id="attendanceConfigForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 border border-gray-200 rounded-lg shadow-sm no-print">
                    <div>
                        <label for="ekskulName" class="block text-sm font-medium text-gray-700">Ekskul</label>
                        <input type="text" id="ekskulName" name="ekskulName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" value="PIDATO BAHASA">
                    </div>
                    <div>
                        <label for="attendanceMonth" class="block text-sm font-medium text-gray-700">Bulan</label>
                        <select id="attendanceMonth" name="attendanceMonth" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            <option value="Januari">Januari</option>
                            <option value="Februari">Februari</option>
                            <option value="Maret">Maret</option>
                            <option value="April">April</option>
                            <option value="Mei">Mei</option>
                            <option value="Juni">Juni</option>
                            <option value="Juli" selected>Juli</option>
                            <option value="Agustus">Agustus</option>
                            <option value="September">September</option>
                            <option value="Oktober">Oktober</option>
                            <option value="November">November</option>
                            <option value="Desember">Desember</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div>
                            <label for="m1Date" class="block text-sm font-medium text-gray-700">M - I</label>
                            <input type="date" id="m1Date" name="m1Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                        <div>
                            <label for="m2Date" class="block text-sm font-medium text-gray-700">M - II</label>
                            <input type="date" id="m2Date" name="m2Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                        <div>
                            <label for="m3Date" class="block text-sm font-medium text-gray-700">M - III</label>
                            <input type="date" id="m3Date" name="m3Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                        <div>
                            <label for="m4Date" class="block text-sm font-medium text-gray-700">M - IV</label>
                            <input type="date" id="m4Date" name="m4Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                        <div>
                            <label for="m5Date" class="block text-sm font-medium text-gray-700">M - V</label>
                            <input type="date" id="m5Date" name="m5Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        </div>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">Simpan Pengaturan Absensi</button>
                    </div>
                </form>

                <div class="flex justify-end space-x-2 mb-4 no-print">
                    <button id="printAttendanceBtn" class="flex items-center px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v5a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Print Absensi
                    </button>
                    <button id="downloadPdfAttendanceBtn" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M.879 7.513A1 1 0 011.707 7h16.586a1 1 0 01.828.487.997.997 0 01-.112 1.022l-6 6a1 1 0 01-1.414 0l-6-6a.997.997 0 01-.112-1.022zM13 16a1 1 0 100 2h4a1 1 0 100-2h-4zM3 16a1 1 0 100 2h4a1 1 0 100-2H3z" clip-rule="evenodd" />
                        </svg>
                        Download PDF Absensi
                    </button>
                </div>

                <!-- Attendance Table -->
                <div class="overflow-x-auto rounded-lg shadow-md table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NO</th>
                                <th scope="col" rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAMA</th>
                                <th scope="col" rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KELAS</th>
                                <th scope="col" rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MINAT</th>
                                <th scope="col" colspan="5" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" id="attendanceMonthHeader">Bulan: Juli</th>
                                <th scope="col" rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KET</th>
                            </tr>
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="m1DateHeader">M - I</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="m2DateHeader">M - II</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="m3DateHeader">M - III</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="m4DateHeader">M - IV</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" id="m5DateHeader">M - V</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Attendance data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-between items-end mt-8 text-sm">
                    <div>
                        <p>Mengetahui,</p>
                        <p class="font-semibold mt-1" id="attendanceKepalaSekolah">Kepala Sekolah</p>
                        <div class="border-b-2 border-gray-400 w-32 mt-8"></div>
                    </div>
                    <div class="text-right">
                        <p>Sampali, <span id="attendanceSampaliDate"></span></p>
                        <p class="font-semibold mt-1" id="attendancePenanggungJawab">Guru Pembimbing</p>
                        <div class="border-b-2 border-gray-400 w-32 mt-8 ml-auto"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Sorted Data Section -->
        <div id="sortedDataSection" class="hidden printable-area">
            <section class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Sortir Data Siswa Berdasarkan Peminatan & Kelas</h2>
                <div class="p-4 border border-gray-200 rounded-lg shadow-sm mb-6 no-print">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="filterMinat" class="block text-sm font-medium text-gray-700">Pilih Peminatan:</label>
                            <select id="filterMinat" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                                <option value="">Semua Peminatan</option>
                                <option value="IPA">IPA</option>
                                <option value="IPS">IPS</option>
                                <option value="Bahasa">Bahasa</option>
                                <option value="Olahraga">Olahraga</option>
                                <option value="Seni">Seni</option>
                                <option value="Teknologi">Teknologi</option>
                                <!-- Options for otherMinat will be dynamically added -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas:</label>
                            <div id="classFilterContainer" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                <!-- Class checkboxes will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 mb-4 no-print">
                    <button id="printSortedBtn" class="flex items-center px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v5a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Print Sortir
                    </button>
                    <button id="downloadPdfSortedBtn" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M.879 7.513A1 1 0 011.707 7h16.586a1 1 0 01.828.487.997.997 0 01-.112 1.022l-6 6a1 1 0 01-1.414 0l-6-6a.997.997 0 01-.112-1.022zM13 16a1 1 0 100 2h4a1 1 0 100-2h-4zM3 16a1 1 0 100 2h4a1 1 0 100-2H3z" clip-rule="evenodd" />
                        </svg>
                        Download PDF Sortir
                    </button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NO</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAMA</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KELAS</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PEMINATAN</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 1</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 2</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 3</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 4</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NILAI 5</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KET</th>
                            </tr>
                        </thead>
                        <tbody id="sortedStudentTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Sorted student data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-6 text-sm text-gray-600">
                    <p>Tanggal: <span id="sortedCurrentDate"></span></p>
                    <p>Total Siswa Terfilter: <span id="totalSortedStudents">0</span></p>
                </div>

                <div class="flex justify-between items-end mt-8 text-sm">
                    <div>
                        <p>Mengetahui,</p>
                        <p class="font-semibold mt-1" id="sortedDisplayKepalaSekolah">Kepala Sekolah</p>
                        <div class="border-b-2 border-gray-400 w-32 mt-8"></div>
                    </div>
                    <div class="text-right">
                        <p>Sampali, <span id="sortedSampaliDate"></span></p>
                        <p class="font-semibold mt-1" id="sortedDisplayPenanggungJawab">Guru Pembimbing</p>
                        <div class="border-b-2 border-gray-400 w-32 mt-8 ml-auto"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Message Box for alerts -->
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-lg font-medium text-gray-800 mb-4"></p>
            <button id="messageBoxCloseBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300">OK</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and user ID
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;
        let appId; // Declare appId globally

        // Function to show custom message box
        function showMessageBox(message) {
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageBox').classList.remove('hidden');
        }

        // Initialize Firebase and set up authentication listener
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Get Firebase config and app ID from global variables
                let firebaseConfig = {};
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    try {
                        firebaseConfig = JSON.parse(__firebase_config);
                    } catch (e) {
                        console.error("Error parsing __firebase_config:", e);
                        showMessageBox("Gagal menginisialisasi aplikasi: Konfigurasi Firebase tidak valid. Pastikan formatnya benar.");
                        return; // Stop initialization if config is invalid
                    }
                } else {
                    showMessageBox("Gagal menginisialisasi aplikasi: Konfigurasi Firebase tidak ditemukan. Pastikan Anda telah menyediakan konfigurasi Firebase.");
                    return; // Stop initialization if config is missing
                }

                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Initialize appId here

                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up authentication state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Set user ID
                        console.log("User ID:", userId);
                        isAuthReady = true; // Mark authentication as ready
                        setupRealtimeListener(); // Start listening for student data changes
                        loadGlobalSettings(); // Load global settings like kepala sekolah
                        loadAttendanceConfig(); // Load attendance settings
                    } else {
                        console.log("No user is signed in.");
                        userId = null;
                        isAuthReady = true; // Still mark as ready even if anonymous
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox("Gagal menginisialisasi aplikasi. Silakan coba lagi. Detail: " + error.message);
            }
        });

        // Event listener for message box close button
        document.getElementById('messageBoxCloseBtn').addEventListener('click', () => {
            document.getElementById('messageBox').classList.add('hidden');
        });

        // DOM Elements for Main Data Section
        const mainDataBtn = document.getElementById('mainDataBtn');
        const attendanceBtn = document.getElementById('attendanceBtn');
        const sortedDataBtn = document.getElementById('sortedDataBtn'); // New button for sorted data
        const mainDataSection = document.getElementById('mainDataSection');
        const attendanceSection = document.getElementById('attendanceSection');
        const sortedDataSection = document.getElementById('sortedDataSection'); // New section for sorted data
        const studentForm = document.getElementById('studentForm');
        const studentTableBody = document.getElementById('studentTableBody');
        const currentDateSpan = document.getElementById('currentDate');
        const totalStudentsSpan = document.getElementById('totalStudents');
        const sampaliDateSpan = document.getElementById('sampaliDate');
        const printMainBtn = document.getElementById('printMainBtn');
        const downloadPdfMainBtn = document.getElementById('downloadPdfMainBtn');
        const kepalaSekolahInput = document.getElementById('kepalaSekolah');
        const penanggungJawabInput = document.getElementById('penanggungJawab');
        const displayKepalaSekolah = document.getElementById('displayKepalaSekolah');
        const displayPenanggungJawab = document.getElementById('displayPenanggungJawab');

        // DOM Elements for Attendance Section
        const attendanceConfigForm = document.getElementById('attendanceConfigForm');
        const ekskulNameInput = document.getElementById('ekskulName');
        const attendanceMonthSelect = document.getElementById('attendanceMonth');
        const m1DateInput = document.getElementById('m1Date');
        const m2DateInput = document.getElementById('m2Date');
        const m3DateInput = document.getElementById('m3Date');
        const m4DateInput = document.getElementById('m4Date');
        const m5DateInput = document.getElementById('m5Date');
        const attendanceTableBody = document.getElementById('attendanceTableBody');
        const attendanceMonthHeader = document.getElementById('attendanceMonthHeader');
        const m1DateHeader = document.getElementById('m1DateHeader');
        const m2DateHeader = document.getElementById('m2DateHeader');
        const m3DateHeader = document.getElementById('m3DateHeader');
        const m4DateHeader = document.getElementById('m4DateHeader');
        const m5DateHeader = document.getElementById('m5DateHeader');
        const attendanceKepalaSekolah = document.getElementById('attendanceKepalaSekolah');
        const attendancePenanggungJawab = document.getElementById('attendancePenanggungJawab');
        const attendanceSampaliDate = document.getElementById('attendanceSampaliDate');
        const printAttendanceBtn = document.getElementById('printAttendanceBtn');
        const downloadPdfAttendanceBtn = document.getElementById('downloadPdfAttendanceBtn');

        // DOM Elements for Sorted Data Section
        const filterMinatSelect = document.getElementById('filterMinat');
        const classFilterContainer = document.getElementById('classFilterContainer'); // New container for class checkboxes
        const sortedStudentTableBody = document.getElementById('sortedStudentTableBody');
        const sortedCurrentDateSpan = document.getElementById('sortedCurrentDate');
        const totalSortedStudentsSpan = document.getElementById('totalSortedStudents');
        const sortedDisplayKepalaSekolah = document.getElementById('sortedDisplayKepalaSekolah');
        const sortedDisplayPenanggungJawab = document.getElementById('sortedDisplayPenanggungJawab');
        const sortedSampaliDateSpan = document.getElementById('sortedSampaliDate');
        const printSortedBtn = document.getElementById('printSortedBtn');
        const downloadPdfSortedBtn = document.getElementById('downloadPdfSortedBtn');


        let students = []; // Array to store student data
        let attendanceSettings = {}; // Object to store attendance configuration

        // Function to format date
        function formatDate(date) {
            if (!date) return ''; // Handle empty date
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(date).toLocaleDateString('id-ID', options);
        }

        // Set current date and Sampali date for all sections
        const today = new Date();
        currentDateSpan.textContent = formatDate(today);
        sampaliDateSpan.textContent = formatDate(today);
        attendanceSampaliDate.textContent = formatDate(today);
        sortedCurrentDateSpan.textContent = formatDate(today);
        sortedSampaliDateSpan.textContent = formatDate(today);

        // Function to render student data in the main table
        function renderStudents() {
            studentTableBody.innerHTML = ''; // Clear existing rows
            if (students.length === 0) {
                studentTableBody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Tidak ada data siswa.</td></tr>`;
            } else {
                students.forEach((student, index) => {
                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.peminatan.join(', ')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai1 ? formatDate(student.tanggalNilai1) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai2 ? formatDate(student.tanggalNilai2) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai3 ? formatDate(student.tanggalNilai3) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai4 ? formatDate(student.tanggalNilai4) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai5 ? formatDate(student.tanggalNilai5) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.keterangan}</td>
                        </tr>
                    `;
                    studentTableBody.insertAdjacentHTML('beforeend', row);
                });
            }
            totalStudentsSpan.textContent = students.length;
        }

        // Function to render attendance data in the attendance table
        function renderAttendanceTable() {
            attendanceTableBody.innerHTML = ''; // Clear existing rows

            // Update attendance headers
            attendanceMonthHeader.textContent = `Bulan: ${attendanceSettings.monthName || 'Juli'}`;
            m1DateHeader.textContent = attendanceSettings.m1Date ? `M - I (${formatDate(attendanceSettings.m1Date)})` : 'M - I';
            m2DateHeader.textContent = attendanceSettings.m2Date ? `M - II (${formatDate(attendanceSettings.m2Date)})` : 'M - II';
            m3DateHeader.textContent = attendanceSettings.m3Date ? `M - III (${formatDate(attendanceSettings.m3Date)})` : 'M - III';
            m4DateHeader.textContent = attendanceSettings.m4Date ? `M - IV (${formatDate(attendanceSettings.m4Date)})` : 'M - IV';
            m5DateHeader.textContent = attendanceSettings.m5Date ? `M - V (${formatDate(attendanceSettings.m5Date)})` : 'M - V';

            if (students.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Tidak ada data siswa.</td></tr>`;
            } else {
                students.forEach((student, index) => {
                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.peminatan.join(', ')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"></td> <!-- M-I attendance mark -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"></td> <!-- M-II attendance mark -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"></td> <!-- M-III attendance mark -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"></td> <!-- M-IV attendance mark -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"></td> <!-- M-V attendance mark -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.keterangan}</td>
                        </tr>
                    `;
                    attendanceTableBody.insertAdjacentHTML('beforeend', row);
                });
            }
        }

        // Function to render sorted student data in the sorted table
        function renderSortedStudents() {
            sortedStudentTableBody.innerHTML = ''; // Clear existing rows

            const selectedMinat = filterMinatSelect.value;
            const selectedClasses = Array.from(document.querySelectorAll('#classFilterContainer input[type="checkbox"]:checked'))
                                       .map(checkbox => checkbox.value);

            const filteredStudents = students.filter(student => {
                const matchesMinat = selectedMinat === '' || (student.peminatan && student.peminatan.includes(selectedMinat));
                const matchesClass = selectedClasses.length === 0 || (student.kelas && selectedClasses.includes(student.kelas));
                return matchesMinat && matchesClass;
            });

            if (filteredStudents.length === 0) {
                sortedStudentTableBody.innerHTML = `<tr><td colspan="10" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">Tidak ada data siswa untuk filter yang dipilih.</td></tr>`;
            } else {
                filteredStudents.forEach((student, index) => {
                    const row = `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nama}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.kelas}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.peminatan.join(', ')}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai1 ? formatDate(student.tanggalNilai1) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai2 ? formatDate(student.tanggalNilai2) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai3 ? formatDate(student.tanggalNilai3) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai4 ? formatDate(student.tanggalNilai4) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.tanggalNilai5 ? formatDate(student.tanggalNilai5) : ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.keterangan}</td>
                        </tr>
                    `;
                    sortedStudentTableBody.insertAdjacentHTML('beforeend', row);
                });
            }
            totalSortedStudentsSpan.textContent = filteredStudents.length;
        }

        // Function to set up real-time listener for student data in Firestore
        function setupRealtimeListener() {
            if (!isAuthReady || !userId) {
                console.log("Firebase not ready or user not authenticated for listener setup.");
                return;
            }

            // Define the collection path for public student data
            const studentCollectionPath = `artifacts/${appId}/public/data/students`;
            const q = query(collection(db, studentCollectionPath));

            onSnapshot(q, (snapshot) => {
                const fetchedStudents = [];
                snapshot.forEach((doc) => {
                    fetchedStudents.push({ id: doc.id, ...doc.data() });
                });
                students = fetchedStudents; // Update the local students array
                renderStudents(); // Re-render the main table
                renderAttendanceTable(); // Re-render the attendance table
                populateFilterOptions(); // Update filter options (minat and class)
                renderSortedStudents(); // Re-render the sorted table with current filters
            }, (error) => {
                console.error("Error fetching real-time data:", error);
                showMessageBox("Gagal memuat data siswa secara real-time.");
            });
        }

        // Function to populate the minat dropdown and class checkboxes
        function populateFilterOptions() {
            // Populate Minat Filter Dropdown
            // Clear existing dynamic options
            Array.from(filterMinatSelect.options).forEach(option => {
                if (!['', 'IPA', 'IPS', 'Bahasa', 'Olahraga', 'Seni', 'Teknologi'].includes(option.value)) {
                    option.remove();
                }
            });

            const uniqueOtherMinat = new Set();
            students.forEach(student => {
                if (student.peminatan) {
                    student.peminatan.forEach(minat => {
                        if (!['IPA', 'IPS', 'Bahasa', 'Olahraga', 'Seni', 'Teknologi'].includes(minat)) {
                            uniqueOtherMinat.add(minat);
                        }
                    });
                }
            });

            uniqueOtherMinat.forEach(minat => {
                const option = document.createElement('option');
                option.value = minat;
                option.textContent = minat;
                filterMinatSelect.appendChild(option);
            });

            // Populate Class Filter Checkboxes
            classFilterContainer.innerHTML = ''; // Clear existing checkboxes
            const uniqueClasses = new Set();
            students.forEach(student => {
                if (student.kelas) {
                    uniqueClasses.add(student.kelas);
                }
            });

            Array.from(uniqueClasses).sort().forEach(kelas => { // Sort classes alphabetically
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `class-${kelas.replace(/\s/g, '-')}`; // Create a unique ID
                input.name = 'filterClass';
                input.value = kelas;
                input.className = 'h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 class-filter-checkbox'; // Add a common class
                const label = document.createElement('label');
                label.htmlFor = input.id;
                label.className = 'ml-2 text-sm text-gray-700';
                label.textContent = kelas;

                div.appendChild(input);
                div.appendChild(label);
                classFilterContainer.appendChild(div);
            });

            // Add event listener to the container for class checkboxes
            classFilterContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('class-filter-checkbox')) {
                    renderSortedStudents(); // Re-render when any class checkbox changes
                }
            });
        }

        // Function to load global settings (Kepala Sekolah, Penanggung Jawab)
        async function loadGlobalSettings() {
            if (!isAuthReady || !userId) {
                console.log("Firebase not ready or user not authenticated for loading global settings.");
                return;
            }

            const settingsDocRef = doc(db, `artifacts/${appId}/public/data/app_settings`, 'global_config');
            try {
                const docSnap = await getDoc(settingsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    kepalaSekolahInput.value = data.kepalaSekolah || '';
                    penanggungJawabInput.value = data.penanggungJawab || '';
                    displayKepalaSekolah.textContent = data.kepalaSekolah || 'Kepala Sekolah';
                    displayPenanggungJawab.textContent = data.penanggungJawab || 'Guru Pembimbing';
                    attendanceKepalaSekolah.textContent = data.kepalaSekolah || 'Kepala Sekolah';
                    attendancePenanggungJawab.textContent = data.penanggungJawab || 'Guru Pembimbing';
                    sortedDisplayKepalaSekolah.textContent = data.kepalaSekolah || 'Kepala Sekolah';
                    sortedDisplayPenanggungJawab.textContent = data.penanggungJawab || 'Guru Pembimbing';
                }
            } catch (error) {
                console.error("Error loading global settings:", error);
                showMessageBox("Gagal memuat pengaturan umum.");
            }
        }

        // Function to save global settings
        async function saveGlobalSettings() {
            if (!isAuthReady || !userId) {
                showMessageBox("Aplikasi belum siap. Silakan coba lagi sebentar.");
                return;
            }

            const settingsDocRef = doc(db, `artifacts/${appId}/public/data/app_settings`, 'global_config');
            const settingsData = {
                kepalaSekolah: kepalaSekolahInput.value,
                penanggungJawab: penanggungJawabInput.value
            };

            try {
                await setDoc(settingsDocRef, settingsData, { merge: true });
                displayKepalaSekolah.textContent = settingsData.kepalaSekolah || 'Kepala Sekolah';
                displayPenanggungJawab.textContent = settingsData.penanggungJawab || 'Guru Pembimbing';
                attendanceKepalaSekolah.textContent = settingsData.kepalaSekolah || 'Kepala Sekolah';
                attendancePenanggungJawab.textContent = settingsData.penanggungJawab || 'Guru Pembimbing';
                sortedDisplayKepalaSekolah.textContent = settingsData.kepalaSekolah || 'Kepala Sekolah';
                sortedDisplayPenanggungJawab.textContent = settingsData.penanggungJawab || 'Guru Pembimbing';
                console.log("Global settings saved successfully!");
            } catch (error) {
                console.error("Error saving global settings:", error);
                showMessageBox("Gagal menyimpan pengaturan umum.");
            }
        }

        // Function to load attendance configuration
        async function loadAttendanceConfig() {
            if (!isAuthReady || !userId) {
                console.log("Firebase not ready or user not authenticated for loading attendance config.");
                return;
            }

            const configDocRef = doc(db, `artifacts/${appId}/public/data/attendance_settings`, 'attendance_config');
            try {
                const docSnap = await getDoc(configDocRef);
                if (docSnap.exists()) {
                    attendanceSettings = docSnap.data();
                    ekskulNameInput.value = attendanceSettings.ekskulName || '';
                    attendanceMonthSelect.value = attendanceSettings.monthName || 'Juli';
                    m1DateInput.value = attendanceSettings.m1Date || '';
                    m2DateInput.value = attendanceSettings.m2Date || '';
                    m3DateInput.value = attendanceSettings.m3Date || '';
                    m4DateInput.value = attendanceSettings.m4Date || '';
                    m5DateInput.value = attendanceSettings.m5Date || '';
                } else {
                    // Set default month if no config exists
                    attendanceSettings.monthName = 'Juli';
                    attendanceMonthSelect.value = 'Juli';
                }
                renderAttendanceTable(); // Re-render attendance table with loaded config
            } catch (error) {
                console.error("Error loading attendance config:", error);
                showMessageBox("Gagal memuat konfigurasi absensi.");
            }
        }

        // Function to save attendance configuration
        async function saveAttendanceConfig() {
            if (!isAuthReady || !userId) {
                showMessageBox("Aplikasi belum siap. Silakan coba lagi sebentar.");
                return;
            }

            const configDocRef = doc(db, `artifacts/${appId}/public/data/attendance_settings`, 'attendance_config');
            const configData = {
                ekskulName: ekskulNameInput.value,
                monthName: attendanceMonthSelect.value,
                m1Date: m1DateInput.value,
                m2Date: m2DateInput.value,
                m3Date: m3DateInput.value,
                m4Date: m4DateInput.value,
                m5Date: m5DateInput.value
            };

            try {
                await setDoc(configDocRef, configData, { merge: true });
                attendanceSettings = configData; // Update local settings
                renderAttendanceTable(); // Re-render attendance table with new config
                showMessageBox("Pengaturan absensi berhasil disimpan!");
            } catch (error) {
                console.error("Error saving attendance config:", error);
                showMessageBox("Gagal menyimpan pengaturan absensi.");
            }
        }

        // Handle student form submission
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showMessageBox("Aplikasi belum siap. Silakan coba lagi sebentar.");
                return;
            }

            // Collect selected minat checkboxes
            const selectedMinat = Array.from(document.querySelectorAll('input[name="minat"]:checked'))
                                     .map(checkbox => checkbox.value);
            const otherMinat = document.getElementById('otherMinat').value.trim();
            if (otherMinat) {
                selectedMinat.push(otherMinat);
            }

            const newStudent = {
                nama: document.getElementById('nama').value,
                kelas: document.getElementById('kelas').value,
                peminatan: selectedMinat, // Use the collected minat array
                tanggalNilai1: document.getElementById('tanggalNilai1').value,
                tanggalNilai2: document.getElementById('tanggalNilai2').value,
                tanggalNilai3: document.getElementById('tanggalNilai3').value,
                tanggalNilai4: document.getElementById('tanggalNilai4').value,
                tanggalNilai5: document.getElementById('tanggalNilai5').value,
                keterangan: document.getElementById('keterangan').value,
                timestamp: new Date().toISOString() // Add a timestamp for ordering
            };

            try {
                // Add new student data to Firestore
                const studentCollectionPath = `artifacts/${appId}/public/data/students`;
                await addDoc(collection(db, studentCollectionPath), newStudent);
                showMessageBox("Data siswa berhasil ditambahkan!");
                studentForm.reset(); // Clear the form
                // Uncheck all minat checkboxes
                document.querySelectorAll('input[name="minat"]:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessageBox("Gagal menambahkan data siswa. Silakan coba lagi.");
            }

            // Also save global settings when form is submitted
            saveGlobalSettings();
        });

        // Handle attendance config form submission
        attendanceConfigForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveAttendanceConfig();
        });

        // Event listener for minat filter dropdown change
        filterMinatSelect.addEventListener('change', () => {
            renderSortedStudents(); // Re-render when minat filter changes
        });

        // Navigation button event listeners
        mainDataBtn.addEventListener('click', () => {
            mainDataSection.classList.remove('hidden');
            attendanceSection.classList.add('hidden');
            sortedDataSection.classList.add('hidden'); // Hide sorted section
            mainDataBtn.classList.add('bg-blue-500', 'text-white');
            mainDataBtn.classList.remove('bg-gray-200', 'text-gray-800');
            attendanceBtn.classList.add('bg-gray-200', 'text-gray-800');
            attendanceBtn.classList.remove('bg-blue-500', 'text-white');
            sortedDataBtn.classList.add('bg-gray-200', 'text-gray-800');
            sortedDataBtn.classList.remove('bg-blue-500', 'text-white');
            loadGlobalSettings(); // Load settings for main section
            renderStudents(); // Ensure main student table is updated
        });

        attendanceBtn.addEventListener('click', () => {
            mainDataSection.classList.add('hidden');
            attendanceSection.classList.remove('hidden');
            sortedDataSection.classList.add('hidden'); // Hide sorted section
            attendanceBtn.classList.add('bg-blue-500', 'text-white');
            attendanceBtn.classList.remove('bg-gray-200', 'text-gray-800');
            mainDataBtn.classList.add('bg-gray-200', 'text-gray-800');
            mainDataBtn.classList.remove('bg-blue-500', 'text-white');
            sortedDataBtn.classList.add('bg-gray-200', 'text-gray-800');
            sortedDataBtn.classList.remove('bg-blue-500', 'text-white');
            loadGlobalSettings(); // Load settings (kepala sekolah etc.) for attendance section
            loadAttendanceConfig(); // Load specific attendance settings
            renderAttendanceTable(); // Ensure attendance table is updated
        });

        sortedDataBtn.addEventListener('click', () => {
            mainDataSection.classList.add('hidden');
            attendanceSection.classList.add('hidden');
            sortedDataSection.classList.remove('hidden'); // Show sorted section
            sortedDataBtn.classList.add('bg-blue-500', 'text-white');
            sortedDataBtn.classList.remove('bg-gray-200', 'text-gray-800');
            mainDataBtn.classList.add('bg-gray-200', 'text-gray-800');
            mainDataBtn.classList.remove('bg-blue-500', 'text-white');
            attendanceBtn.classList.add('bg-gray-200', 'text-gray-800');
            attendanceBtn.classList.remove('bg-blue-500', 'text-white');
            loadGlobalSettings(); // Load settings for sorted section
            populateFilterOptions(); // Re-populate filters to ensure they are up-to-date
            renderSortedStudents(); // Render sorted students based on current filter
        });

        // Print functionality for main data section
        printMainBtn.addEventListener('click', () => {
            const originalContents = document.body.innerHTML;
            const printContents = document.getElementById('mainDataSection').innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload(); // Reload to restore original state
        });

        // Print functionality for attendance section
        printAttendanceBtn.addEventListener('click', () => {
            const originalContents = document.body.innerHTML;
            const printContents = document.getElementById('attendanceSection').innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload(); // Reload to restore original state
        });

        // Print functionality for sorted data section
        printSortedBtn.addEventListener('click', () => {
            const originalContents = document.body.innerHTML;
            const printContents = document.getElementById('sortedDataSection').innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload(); // Reload to restore original state
        });

        // Download PDF functionality (placeholder - requires a library like jsPDF)
        downloadPdfMainBtn.addEventListener('click', () => {
            showMessageBox("Fungsi Download PDF belum diimplementasikan. Anda dapat menggunakan fitur cetak browser dan menyimpannya sebagai PDF.");
        });

        downloadPdfAttendanceBtn.addEventListener('click', () => {
            showMessageBox("Fungsi Download PDF Absensi belum diimplementasikan. Anda dapat menggunakan fitur cetak browser dan menyimpannya sebagai PDF.");
        });

        downloadPdfSortedBtn.addEventListener('click', () => {
            showMessageBox("Fungsi Download PDF Sortir belum diimplementasikan. Anda dapat menggunakan fitur cetak browser dan menyimpannya sebagai PDF.");
        });

        // Initial render when the page loads
        renderStudents();
        loadGlobalSettings();
        loadAttendanceConfig(); // Load attendance config on initial load as well
        populateFilterOptions(); // Populate filter options on initial load
    </script>
</body>
</html>
